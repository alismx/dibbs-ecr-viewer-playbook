---

# Jail2ban configuration for standard jail settings
- name: Create fail2ban directory for custom configurations
  ansible.builtin.file:
    path: /etc/fail2ban
    state: directory
    mode: '0755'

- name: Configure default jail2ban settings
  ansible.builtin.copy:
    content: |
      # Global settings
      [DEFAULT]
      bantime = 1h
      findtime = 10m
      maxretry = 5
      backend = auto
      loglevel = info

      # SSH jail configuration
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      maxretry = 3

      # HTTP authentication jail
      [http-auth]
      enabled = false
      port = http,https
      filter = http-auth
      maxretry = 3

      # Docker jail for ecr-viewer protection
      [docker-ecr-viewer]
      enabled = true
      port = http,https
      filter = docker-ecr-viewer
      action = %(action_mwl)s
      maxretry = 3
      bantime = 1h
    dest: /etc/fail2ban/jail.local
    mode: '0644'
    backup: true

- name: Configure custom filter for ecr-viewer authentication
  ansible.builtin.copy:
    content: |
      [Definition]
      failregex = ^.*authentication failure; logname= uid=0 euid=0 tty=http ruser= rhost=<HOST>.*$
                  ^.*error: authentication failure.*from <HOST>.*$
      ignoreregex =
    dest: /etc/fail2ban/filter.d/docker-ecr-viewer.conf
    mode: '0644'
    backup: true

# Note: fail2ban restart handled via handler in playbook.yaml or system service management
- name: Ensure fail2ban is running after configuration change
  ansible.builtin.systemd:
    name: fail2ban
    state: started
    enabled: true
